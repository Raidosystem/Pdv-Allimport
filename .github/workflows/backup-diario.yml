name: Backup AutomÃ¡tico DiÃ¡rio

on:
  # Executa todos os dias Ã s 2:00 AM UTC (23:00 BrasÃ­lia)
  schedule:
    - cron: '0 2 * * *'
  
  # Permite execuÃ§Ã£o manual pelo GitHub Actions UI
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    name: Criar Backup DiÃ¡rio do PDV
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ”„ Executar Backup no Supabase
        id: backup
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ðŸ”„ Iniciando backup automÃ¡tico..."
          echo "ðŸ“… Data/Hora: $(date)"
          
          # Executar funÃ§Ã£o RPC de backup
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${SUPABASE_URL}/rest/v1/rpc/criar_backup_automatico_diario" \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation")
          
          # Separar corpo e status code
          HTTP_BODY=$(echo "$RESPONSE" | head -n -1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          
          echo "ðŸ“Š Status HTTP: $HTTP_CODE"
          echo "ðŸ“¦ Resposta:"
          echo "$HTTP_BODY" | jq '.'
          
          # Verificar se a requisiÃ§Ã£o foi bem-sucedida
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ Erro HTTP: Status $HTTP_CODE"
            exit 1
          fi
          
          # Verificar se o backup foi bem-sucedido
          SUCESSO=$(echo "$HTTP_BODY" | jq -r '.sucesso // false')
          if [ "$SUCESSO" != "true" ]; then
            echo "âŒ Backup falhou!"
            echo "Erro: $(echo "$HTTP_BODY" | jq -r '.erro // "Desconhecido"')"
            exit 1
          fi
          
          echo "âœ… Backup concluÃ­do com sucesso!"
          echo "timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
      
      - name: ðŸ“Š Verificar backups criados
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ðŸ“Š Verificando backups recentes..."
          
          curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/backups?select=id,tipo,status,total_clientes,total_produtos,tamanho_bytes,created_at&tipo=eq.automatico&order=created_at.desc&limit=5" \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            | jq '.[] | {
                id: .id,
                status: .status,
                clientes: .total_clientes,
                produtos: .total_produtos,
                tamanho_mb: (.tamanho_bytes / 1024 / 1024 | round),
                criado_em: .created_at
              }'
      
      - name: ðŸ§¹ Verificar limpeza de backups antigos
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ðŸ§¹ Verificando total de backups automÃ¡ticos..."
          
          TOTAL=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/backups?select=count&tipo=eq.automatico" \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Prefer: count=exact" \
            | jq -r '.[0].count // 0')
          
          echo "ðŸ“¦ Total de backups automÃ¡ticos: $TOTAL"
          
          if [ "$TOTAL" -gt 50 ]; then
            echo "âš ï¸ Muitos backups automÃ¡ticos ($TOTAL). Considere aumentar a limpeza."
          else
            echo "âœ… Quantidade de backups OK"
          fi
      
      - name: ðŸ“ Resumo do Backup
        if: always()
        run: |
          echo "## ðŸ“Š Resumo do Backup AutomÃ¡tico" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Data/Hora**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status == 'success' && 'âœ… Sucesso' || 'âŒ Falhou' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… Backup concluÃ­do com sucesso!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Os dados foram salvos na tabela \`backups\` do Supabase." >> $GITHUB_STEP_SUMMARY
            echo "Para visualizar, acesse: Admin > Backups no sistema PDV." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Falha no Backup" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Verifique os logs acima para mais detalhes." >> $GITHUB_STEP_SUMMARY
          fi
