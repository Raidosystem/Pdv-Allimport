name: Backup AutomÃ¡tico - Email

on:
  # Executa todos os dias Ã s 2:00 AM UTC (23:00 BrasÃ­lia)
  schedule:
    - cron: '0 2 * * *'
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  backup-to-email:
    runs-on: ubuntu-latest
    name: Backup PDV â†’ Email
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ”„ Criar backup no Supabase
        id: backup
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ðŸ”„ Criando backup no Supabase..."
          
          RESPONSE=$(curl -s -X POST \
            "${SUPABASE_URL}/rest/v1/rpc/criar_backup_automatico_diario" \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation")
          
          echo "$RESPONSE" | jq '.'
          
          if echo "$RESPONSE" | jq -e '.sucesso == true' > /dev/null; then
            echo "âœ… Backup criado no Supabase!"
          else
            echo "âŒ Erro ao criar backup!"
            exit 1
          fi
      
      - name: ðŸ“¥ Baixar backup do Supabase
        id: download
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ðŸ“¥ Baixando backup mais recente..."
          
          # Buscar Ãºltimo backup automÃ¡tico
          BACKUP=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/backups?select=id,data,total_clientes,total_produtos,total_vendas,total_ordens,created_at&tipo=eq.automatico&order=created_at.desc&limit=1" \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}")
          
          # Salvar informaÃ§Ãµes para o email
          echo "$BACKUP" | jq '.[0]' > backup-info.json
          
          CLIENTES=$(cat backup-info.json | jq -r '.total_clientes')
          PRODUTOS=$(cat backup-info.json | jq -r '.total_produtos')
          VENDAS=$(cat backup-info.json | jq -r '.total_vendas')
          ORDENS=$(cat backup-info.json | jq -r '.total_ordens')
          
          echo "total_clientes=$CLIENTES" >> $GITHUB_OUTPUT
          echo "total_produtos=$PRODUTOS" >> $GITHUB_OUTPUT
          echo "total_vendas=$VENDAS" >> $GITHUB_OUTPUT
          echo "total_ordens=$ORDENS" >> $GITHUB_OUTPUT
          
          # Extrair apenas o campo 'data' (backup real)
          cat backup-info.json | jq '.data' > backup-pdv.json
          
          # Criar nome do arquivo
          FILENAME="backup-pdv-$(date +%Y-%m-%d).json"
          mv backup-pdv.json "$FILENAME"
          
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "âœ… Backup baixado: $FILENAME"
      
      - name: ðŸ“§ Enviar backup por email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_SMTP_SERVER || 'smtp.gmail.com' }}
          server_port: ${{ secrets.EMAIL_SMTP_PORT || '587' }}
          username: ${{ secrets.EMAIL_SENDER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[PDV] Backup AutomÃ¡tico - $(date +%d/%m/%Y)"
          to: ${{ secrets.EMAIL_RECEIVER }}
          from: ${{ secrets.EMAIL_SENDER }}
          body: |
            ðŸ”„ Backup AutomÃ¡tico do Sistema PDV
            
            ðŸ“Š RESUMO DO BACKUP
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            ðŸ“… Data: $(date +"%d/%m/%Y Ã s %H:%M")
            
            ðŸ“¦ DADOS SALVOS:
            â€¢ Clientes: ${{ steps.download.outputs.total_clientes }}
            â€¢ Produtos: ${{ steps.download.outputs.total_produtos }}
            â€¢ Vendas: ${{ steps.download.outputs.total_vendas }}
            â€¢ Ordens de ServiÃ§o: ${{ steps.download.outputs.total_ordens }}
            
            ðŸ“Ž ARQUIVO ANEXO:
            â€¢ Nome: ${{ steps.download.outputs.filename }}
            â€¢ Formato: JSON
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            ðŸ’¾ COMO RESTAURAR:
            1. Baixe o arquivo JSON anexado
            2. Acesse: Admin > Backups > Restaurar de PC
            3. Selecione o arquivo baixado
            4. Clique em "Restaurar"
            
            ðŸ”’ SEGURANÃ‡A:
            âœ“ Backup criptografado em trÃ¢nsito
            âœ“ Enviado apenas para seu email
            âœ“ Mantenha este email salvo
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            Este Ã© um email automÃ¡tico do sistema PDV Allimport.
            NÃ£o responda a este email.
            
            Sistema de Backup AutomÃ¡tico v1.0
          attachments: ${{ steps.download.outputs.filename }}
          priority: normal
      
      - name: ðŸ§¹ Limpar arquivos temporÃ¡rios
        if: always()
        run: |
          rm -f backup-*.json
      
      - name: ðŸ“Š Resumo
        if: success()
        run: |
          echo "## âœ… Backup Enviado por Email" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Data**: $(date +"%d/%m/%Y Ã s %H:%M")" >> $GITHUB_STEP_SUMMARY
          echo "- **Arquivo**: ${{ steps.download.outputs.filename }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Para**: ${{ secrets.EMAIL_RECEIVER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Enviado âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Dados no Backup:" >> $GITHUB_STEP_SUMMARY
          echo "- Clientes: ${{ steps.download.outputs.total_clientes }}" >> $GITHUB_STEP_SUMMARY
          echo "- Produtos: ${{ steps.download.outputs.total_produtos }}" >> $GITHUB_STEP_SUMMARY
          echo "- Vendas: ${{ steps.download.outputs.total_vendas }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ordens: ${{ steps.download.outputs.total_ordens }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“§ Verifique sua caixa de entrada!" >> $GITHUB_STEP_SUMMARY
