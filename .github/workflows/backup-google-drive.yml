name: Backup AutomÃ¡tico - Google Drive

on:
  # Executa todos os dias Ã s 2:00 AM UTC (23:00 BrasÃ­lia)
  schedule:
    - cron: '0 2 * * *'
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  backup-to-drive:
    runs-on: ubuntu-latest
    name: Backup PDV â†’ Google Drive
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ”„ Criar backup no Supabase
        id: backup
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ðŸ”„ Criando backup no Supabase..."
          
          RESPONSE=$(curl -s -X POST \
            "${SUPABASE_URL}/rest/v1/rpc/criar_backup_automatico_diario" \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation")
          
          echo "$RESPONSE" | jq '.'
          
          if echo "$RESPONSE" | jq -e '.sucesso == true' > /dev/null; then
            echo "âœ… Backup criado no Supabase!"
          else
            echo "âŒ Erro ao criar backup!"
            exit 1
          fi
      
      - name: ðŸ“¥ Baixar Ãºltimo backup do Supabase
        id: download
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ðŸ“¥ Baixando backup mais recente..."
          
          # Buscar Ãºltimo backup automÃ¡tico
          BACKUP=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/backups?select=id,data,empresa_id,created_at&tipo=eq.automatico&order=created_at.desc&limit=1" \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}")
          
          echo "$BACKUP" | jq '.[0]' > backup-temp.json
          
          # Extrair apenas o campo 'data' (que contÃ©m o backup real)
          cat backup-temp.json | jq '.data' > backup-pdv.json
          
          # Criar nome do arquivo com data
          FILENAME="backup-pdv-$(date +%Y-%m-%d).json"
          mv backup-pdv.json "$FILENAME"
          
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "âœ… Backup baixado: $FILENAME"
      
      - name: ðŸ“ Configurar Google Drive
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
      
      - name: â˜ï¸ Enviar para Google Drive
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
          FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          BACKUP_FILE: ${{ steps.download.outputs.filename }}
        run: |
          cat > upload_to_drive.py << 'EOF'
          import os
          import json
          from datetime import datetime
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          # Carregar credenciais
          credentials_json = os.environ['GOOGLE_CREDENTIALS']
          credentials_dict = json.loads(credentials_json)
          credentials = service_account.Credentials.from_service_account_info(
              credentials_dict,
              scopes=['https://www.googleapis.com/auth/drive.file']
          )

          # Criar serviÃ§o do Drive
          service = build('drive', 'v3', credentials=credentials)

          # IDs e informaÃ§Ãµes
          root_folder_id = os.environ['FOLDER_ID']
          backup_file = os.environ['BACKUP_FILE']
          
          # Obter data atual
          now = datetime.now()
          year = now.strftime('%Y')
          month = now.strftime('%m-%B')  # Ex: 11-November
          
          print(f"ðŸ“ Organizando backup: {year}/{month}/")
          
          # FunÃ§Ã£o para criar ou buscar pasta
          def get_or_create_folder(parent_id, folder_name):
              query = f"name='{folder_name}' and '{parent_id}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false"
              results = service.files().list(q=query, fields='files(id, name)').execute()
              folders = results.get('files', [])
              
              if folders:
                  print(f"âœ… Pasta encontrada: {folder_name}")
                  return folders[0]['id']
              else:
                  folder_metadata = {
                      'name': folder_name,
                      'mimeType': 'application/vnd.google-apps.folder',
                      'parents': [parent_id]
                  }
                  folder = service.files().create(body=folder_metadata, fields='id').execute()
                  print(f"ðŸ“ Pasta criada: {folder_name}")
                  return folder['id']
          
          # Criar estrutura de pastas: Backups PDV/2025/11-November/
          year_folder_id = get_or_create_folder(root_folder_id, year)
          month_folder_id = get_or_create_folder(year_folder_id, month)
          
          # Verificar se jÃ¡ existe backup com o mesmo nome
          query = f"name='{backup_file}' and '{month_folder_id}' in parents and trashed=false"
          existing = service.files().list(q=query, fields='files(id, name)').execute()
          
          if existing.get('files'):
              print(f"ðŸ—‘ï¸ Removendo backup antigo do dia...")
              for file in existing['files']:
                  service.files().delete(fileId=file['id']).execute()
          
          # Upload do arquivo
          print(f"â˜ï¸ Enviando {backup_file} para Google Drive...")
          
          file_metadata = {
              'name': backup_file,
              'parents': [month_folder_id]
          }
          
          media = MediaFileUpload(backup_file, mimetype='application/json', resumable=True)
          
          file = service.files().create(
              body=file_metadata,
              media_body=media,
              fields='id, name, size, webViewLink'
          ).execute()
          
          print(f"âœ… Backup enviado com sucesso!")
          print(f"ðŸ“„ Nome: {file['name']}")
          print(f"ðŸ“Š Tamanho: {int(file['size']) / 1024 / 1024:.2f} MB")
          print(f"ðŸ”— Link: {file['webViewLink']}")
          EOF
          
          python upload_to_drive.py
      
      - name: ðŸ§¹ Limpar arquivos temporÃ¡rios
        if: always()
        run: |
          rm -f backup-*.json upload_to_drive.py
      
      - name: ðŸ“Š Resumo
        if: success()
        run: |
          echo "## âœ… Backup Enviado para Google Drive" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Data**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Arquivo**: ${{ steps.download.outputs.filename }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Destino**: Google Drive" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Sucesso âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Acesse seu Google Drive para visualizar o backup!" >> $GITHUB_STEP_SUMMARY
