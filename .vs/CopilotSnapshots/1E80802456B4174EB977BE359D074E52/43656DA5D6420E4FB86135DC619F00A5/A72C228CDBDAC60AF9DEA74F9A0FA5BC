# 🔧 O QUE REALMENTE ESTÁ ACONTECENDO COM AS PERMISSÕES

## ❌ PROBLEMA IDENTIFICADO

**Jennifer tem as permissões CORRETAS** (34 únicas), MAS:
- O banco de dados tem **63 registros duplicados**
- Causa: Script anterior executou função `mapear_permissoes_granulares()` que duplicou tudo

### 📊 Evidência nos Logs
```
📦 [usePermissions] funcao_permissoes: Array(63)  ← 63 registros no banco
🎯 [usePermissions] Total de permissões extraídas: 34  ← 34 únicas após dedupe
```

### ✅ O QUE ESTÁ FUNCIONANDO
- Jennifer tem **34 permissões únicas corretas**
- Ela vê **4 módulos**: Vendas, Produtos, Clientes, Caixa ✅
- Ela **NÃO VÊ**: Ordens de Serviço, Relatórios ❌ (não foram selecionadas pelo admin)

### ❌ O QUE ESTÁ ERRADO
- O banco tem **63 registros** quando deveria ter **34**
- Há permissões duplicadas (`vendas:read` aparece 4x, `caixa:read` aparece 6x)

---

## 🛠️ SOLUÇÃO COMPLETA

### ❌ Erro ao Executar o Primeiro Script?
Se você recebeu este erro:
```
ERROR: 23505: could not create unique index "funcao_permissoes_pkey"
DETAIL: Key (funcao_id, permissao_id)=(...) is duplicated.
```

**Isso confirma o problema das duplicatas!** Use o script V2 abaixo.

### Passo 1: Execute o Script SQL Correto
**Arquivo**: `CORRIGIR_PERMISSOES_V2_FINAL.sql` ⭐ (USE ESTE!)

```bash
# Copie TODO o conteúdo do arquivo CORRIGIR_PERMISSOES_V2_FINAL.sql
# Cole no Supabase SQL Editor
# Clique em "Run" (ou Ctrl+Enter)
```

**Por que V2?**
- ✅ Remove duplicatas ANTES de criar constraint
- ✅ Mostra quantas duplicatas foram encontradas
- ✅ Verifica se não há mais duplicatas depois
- ✅ Recria as permissões corretamente

### O que o script faz:
1. ✅ Remove função `mapear_permissoes_granulares()` (causa das duplicatas)
2. 🗑️ Deleta TODAS as permissões atuais de Jennifer
3. ➕ Adiciona de volta APENAS as 34 permissões escolhidas pelo admin
4. 🔒 Cria constraint `PRIMARY KEY` para prevenir duplicatas futuras
5. 📊 Mostra relatório de verificação

---

## 📋 PERMISSÕES QUE JENNIFER DEVE TER

### ✅ PERMITIDAS (34 permissões)

#### 🛒 Vendas (8)
- `vendas:create` - Criar venda
- `vendas:read` - Ver vendas
- `vendas:update` - Editar venda
- `vendas:delete` - Excluir venda
- `vendas:cancel` - Cancelar venda
- `vendas:discount` - Aplicar desconto
- `vendas:print` - Imprimir cupom
- `vendas:refund` - Fazer estorno

#### 📦 Produtos (6)
- `produtos:read` - Ver produtos
- `produtos:create` - Criar produto
- `produtos:export` - Exportar produtos
- `produtos:manage_categories` - Gerenciar categorias
- `produtos:adjust_price` - Alterar preços
- `produtos:manage_stock` - Gerenciar estoque

#### 👥 Clientes (4)
- `clientes:read` - Ver clientes
- `clientes:create` - Criar cliente
- `clientes:update` - Editar cliente
- `clientes:delete` - Excluir cliente

#### 💰 Caixa (5)
- `caixa:view` - Visualizar caixa
- `caixa:open` - Abrir caixa
- `caixa:close` - Fechar caixa
- `caixa:suprimento` - Fazer suprimento
- `caixa:sangria` - Fazer sangria

#### 🔧 Ordens de Serviço (5)
- `ordens:read` - Ver ordens
- `ordens:create` - Criar ordem
- `ordens:update` - Editar ordem
- `ordens:delete` - Excluir ordem
- `ordens:print` - Imprimir ordem

#### ⚙️ Configurações (6)
- `configuracoes:read` - Ver configurações
- `configuracoes:update` - Alterar configurações
- `configuracoes:appearance` - Configurar aparência
- `configuracoes:print_settings` - Configurar impressão
- `configuracoes:backup` - Fazer backup
- `configuracoes:integrations` - Gerenciar integrações

### ❌ NÃO PERMITIDAS (não selecionadas pelo admin)
- ❌ **Relatórios** (módulo inteiro)
- ❌ **Administração** (módulo inteiro)

---

## 🔄 APÓS EXECUTAR O SCRIPT

### 1. Verificar Resultado
Você verá esta mensagem no final:
```
✅ CONCLUSÃO
🎉 Duplicatas removidas!
🔄 Jennifer deve fazer LOGOUT e LOGIN novamente
📊 Total de permissões: 34
```

Se aparecer **63** ao invés de **34**, algo deu errado. Execute novamente.

### 2. Jennifer Deve Fazer Logout/Login
1. Feche TODAS as abas do sistema
2. Abra novamente
3. Faça LOGIN
4. Verifique os módulos visíveis

### 3. Módulos Esperados
Jennifer deve ver **6 módulos**:
- ✅ Vendas
- ✅ Produtos
- ✅ Clientes
- ✅ Caixa
- ✅ Ordens de Serviço
- ✅ Configurações

Jennifer **NÃO** deve ver:
- ❌ Relatórios
- ❌ Administração

---

## 🐛 SE AINDA NÃO FUNCIONAR

### Diagnóstico 1: Verificar Total de Permissões
```sql
SELECT COUNT(*)
FROM funcao_permissoes fp
JOIN funcionarios f ON f.funcao_id = fp.funcao_id
WHERE f.email = 'sousajenifer895@gmail.com';
```

**Resultado esperado**: `34`
**Se aparecer 63**: Execute `CORRIGIR_PERMISSOES_DEFINITIVO.sql` novamente

### Diagnóstico 2: Ver Permissões Detalhadas
```sql
SELECT 
  p.recurso,
  p.acao,
  COUNT(*) as vezes_cadastrada
FROM funcao_permissoes fp
JOIN funcionarios f ON f.funcao_id = fp.funcao_id
JOIN permissoes p ON p.id = fp.permissao_id
WHERE f.email = 'sousajenifer895@gmail.com'
GROUP BY p.recurso, p.acao
HAVING COUNT(*) > 1  -- Mostrar apenas duplicatas
ORDER BY COUNT(*) DESC;
```

**Resultado esperado**: Nenhuma linha (sem duplicatas)
**Se aparecer linhas**: Há duplicatas, execute o script novamente

### Diagnóstico 3: Limpar Cache do Navegador
Se o banco está correto mas o sistema não reconhece:
1. Pressione `Ctrl + Shift + Del`
2. Marque "Cookies" e "Cache"
3. Clique em "Limpar dados"
4. Feche o navegador
5. Abra novamente e faça login

---

## 🔮 PREVENIR ESTE PROBLEMA NO FUTURO

### ✅ O que o script já corrigiu:
- ✅ Removeu função `mapear_permissoes_granulares()` (causa das duplicatas)
- ✅ Removeu triggers automáticos
- ✅ Criou constraint `PRIMARY KEY (funcao_id, permissao_id)` para prevenir duplicatas

### ⚠️ Ao adicionar novos funcionários:
1. Crie a função (ex: "Vendedor")
2. Selecione apenas as permissões desejadas
3. **NÃO** execute scripts SQL que adicionam permissões automaticamente
4. Deixe o sistema gerenciar via interface web

### ⚠️ Ao editar permissões existentes:
1. Vá em **Administração → Funções & Permissões**
2. Clique em **"Permissões"** na função desejada
3. Marque/desmarque as permissões
4. Clique em **"Salvar"**
5. **NÃO** execute scripts SQL manuais

---

## 📞 SUPORTE

Se após seguir todos os passos o problema persistir:

1. **Tire print** do resultado da query:
   ```sql
   SELECT COUNT(*) FROM funcao_permissoes fp
   JOIN funcionarios f ON f.funcao_id = fp.funcao_id
   WHERE f.email = 'sousajenifer895@gmail.com';
   ```

2. **Tire print** dos módulos visíveis no menu de Jennifer

3. **Copie** os logs do console (F12 → Console)

4. **Envie** todas as informações para análise

---

## ✅ CHECKLIST FINAL

Antes de considerar o problema resolvido:

- [ ] Executei `CORRIGIR_PERMISSOES_DEFINITIVO.sql` no Supabase
- [ ] Verifiquei que o total de permissões é **34** (não 63)
- [ ] Jennifer fez logout completo
- [ ] Jennifer fez login novamente
- [ ] Limpei o cache do navegador
- [ ] Jennifer vê os 6 módulos esperados
- [ ] Jennifer **NÃO** vê Relatórios e Administração
- [ ] Testei criar uma venda com Jennifer
- [ ] Testei abrir/fechar caixa com Jennifer

---

**🎯 RESUMO**: O problema não é que "Jennifer tem todas as permissões" - ela tem **exatamente** as permissões que você selecionou (34). O problema é que o **banco de dados tem duplicatas** (63 registros). Execute o script para limpar e tudo funcionará perfeitamente!
