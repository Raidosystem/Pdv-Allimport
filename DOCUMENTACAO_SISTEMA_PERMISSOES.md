# üéØ Sistema de Permiss√µes Moderno - PDV Allimport

## üìã Vis√£o Geral

O sistema de permiss√µes foi completamente reformulado para oferecer uma **interface visual intuitiva**, **templates predefinidos** e **gerenciamento simplificado** de acesso dos funcion√°rios.

---

## ‚ú® Principais Melhorias

### 1. **Interface Visual Moderna**
- ‚úÖ **Toggle switches** para ativar/desativar permiss√µes
- ‚úÖ **Categorias organizadas** por m√≥dulos (Vendas, Produtos, Clientes, etc.)
- ‚úÖ **Cores diferenciadas** para cada categoria
- ‚úÖ **√çcones intuitivos** para cada permiss√£o
- ‚úÖ **Resumo visual** de permiss√µes ativas

### 2. **Templates Predefinidos**
Cinco templates prontos para uso imediato:

#### üî¥ **Administrador**
- Acesso total ao sistema
- Todas as permiss√µes habilitadas
- Ideal para: Propriet√°rio, Gerente Geral

#### üü£ **Gerente**
- Gerencia vendas, estoque e relat√≥rios
- Sem acesso a configura√ß√µes do sistema
- Ideal para: Gerente de Loja, Supervisor

#### üîµ **Vendedor**
- Realiza vendas e atende clientes
- Acesso limitado a vendas e cadastro de clientes
- Ideal para: Vendedor, Atendente

#### üü¢ **T√©cnico**
- Gerencia ordens de servi√ßo
- Acesso completo a OS e clientes
- Ideal para: T√©cnico, Assist√™ncia T√©cnica

#### üü° **Operador de Caixa**
- Opera caixa e realiza vendas
- Sem permiss√£o para descontos ou edi√ß√£o
- Ideal para: Caixa, Operador

---

## üé® Estrutura de Permiss√µes

### **M√≥dulos Principais** (Controle de Acesso)
```typescript
{
  vendas: boolean,           // Acessa m√≥dulo Vendas
  produtos: boolean,          // Acessa m√≥dulo Produtos
  clientes: boolean,          // Acessa m√≥dulo Clientes
  caixa: boolean,             // Acessa m√≥dulo Caixa
  ordens_servico: boolean,    // Acessa m√≥dulo OS
  funcionarios: boolean,      // Acessa m√≥dulo Funcion√°rios
  relatorios: boolean,        // Acessa m√≥dulo Relat√≥rios
  configuracoes: boolean,     // Acessa Configura√ß√µes
  backup: boolean             // Acessa Backup
}
```

### **Permiss√µes Espec√≠ficas de Vendas**
```typescript
{
  pode_criar_vendas: boolean,    // Criar nova venda
  pode_editar_vendas: boolean,   // Editar venda existente
  pode_cancelar_vendas: boolean, // Cancelar venda
  pode_aplicar_desconto: boolean // Aplicar desconto
}
```

### **Permiss√µes Espec√≠ficas de Produtos**
```typescript
{
  pode_criar_produtos: boolean,     // Cadastrar produto
  pode_editar_produtos: boolean,    // Editar produto
  pode_deletar_produtos: boolean,   // Excluir produto
  pode_gerenciar_estoque: boolean   // Ajustar estoque
}
```

### **Permiss√µes Espec√≠ficas de Clientes**
```typescript
{
  pode_criar_clientes: boolean,   // Cadastrar cliente
  pode_editar_clientes: boolean,  // Editar cliente
  pode_deletar_clientes: boolean  // Excluir cliente
}
```

### **Permiss√µes Espec√≠ficas de Caixa**
```typescript
{
  pode_abrir_caixa: boolean,          // Abrir caixa
  pode_fechar_caixa: boolean,         // Fechar caixa
  pode_gerenciar_movimentacoes: boolean // Adicionar/remover dinheiro
}
```

### **Permiss√µes Espec√≠ficas de OS**
```typescript
{
  pode_criar_os: boolean,      // Criar ordem de servi√ßo
  pode_editar_os: boolean,     // Editar OS
  pode_finalizar_os: boolean   // Finalizar/entregar OS
}
```

### **Permiss√µes de Administra√ß√£o**
```typescript
{
  pode_ver_todos_relatorios: boolean,    // Visualizar relat√≥rios
  pode_exportar_dados: boolean,          // Exportar relat√≥rios
  pode_alterar_configuracoes: boolean,   // Alterar configura√ß√µes
  pode_gerenciar_funcionarios: boolean,  // Gerenciar equipe
  pode_fazer_backup: boolean             // Fazer backup
}
```

---

## üöÄ Como Usar

### **1. Criar Novo Funcion√°rio**
1. Acesse **Funcion√°rios** no menu
2. Clique em **"Novo Funcion√°rio"**
3. Preencha os dados b√°sicos (nome, cargo, e-mail, telefone)
4. Escolha um **template r√°pido** ou personalize as permiss√µes
5. Clique em **"Criar Funcion√°rio"**

### **2. Editar Permiss√µes**
1. Na lista de funcion√°rios, clique no √≠cone de **editar** (‚úèÔ∏è)
2. Role at√© **"Permiss√µes de Acesso"**
3. Use os **toggle switches** para ativar/desativar permiss√µes
4. Ou escolha um **template predefinido**
5. Clique em **"Salvar Altera√ß√µes"**

### **3. Visualizar Permiss√µes**
1. Na lista de funcion√°rios, clique em **"Ver Permiss√µes"**
2. Veja todas as permiss√µes organizadas por categoria
3. Permiss√µes ativas s√£o destacadas com cores

### **4. Aplicar Template via SQL**
```sql
-- Aplicar template a um funcion√°rio
SELECT aplicar_template_permissoes(
  'UUID_DO_FUNCIONARIO', 
  'vendedor'  -- Op√ß√µes: admin, gerente, vendedor, tecnico, caixa
);
```

---

## üìä Componentes Criados

### **1. PermissionsManager.tsx**
- Componente visual de gerenciamento de permiss√µes
- Templates predefinidos
- Categorias expans√≠veis
- Toggle switches
- Resumo de permiss√µes

**Localiza√ß√£o:** `/src/components/admin/PermissionsManager.tsx`

### **2. FuncionariosPage.tsx**
- P√°gina completa de gerenciamento de funcion√°rios
- Integra√ß√£o com PermissionsManager
- Cria√ß√£o, edi√ß√£o e visualiza√ß√£o
- Ativa√ß√£o/desativa√ß√£o de funcion√°rios

**Localiza√ß√£o:** `/src/pages/admin/FuncionariosPage.tsx`

### **3. useEmpresa Hook**
- Hook atualizado com novo sistema de permiss√µes
- Cria funcion√°rios com permiss√µes JSON padronizadas
- Suporta atualiza√ß√£o de permiss√µes

**Localiza√ß√£o:** `/src/hooks/useEmpresa.ts`

---

## üóÉÔ∏è Banco de Dados

### **Estrutura da Tabela `funcionarios`**
```sql
CREATE TABLE funcionarios (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  empresa_id UUID REFERENCES empresas(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  nome VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL,
  telefone VARCHAR(20),
  cargo VARCHAR(100) NOT NULL,
  ativo BOOLEAN DEFAULT true,
  permissoes JSONB NOT NULL DEFAULT '{}', -- ‚úÖ Campo JSON para permiss√µes
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### **Fun√ß√µes SQL Dispon√≠veis**
```sql
-- Aplicar template de permiss√µes
SELECT aplicar_template_permissoes('uuid_funcionario', 'template_nome');

-- Verificar permiss√µes de todos funcion√°rios
SELECT 
  nome,
  cargo,
  permissoes->>'ordens_servico' as acesso_os,
  permissoes->>'configuracoes' as acesso_config
FROM funcionarios;
```

---

## üéØ Casos de Uso

### **Caso 1: Jennifer (T√©cnica)**
**Problema:** Jennifer n√£o via OS e tinha acesso a Configura√ß√µes

**Solu√ß√£o:**
```sql
UPDATE funcionarios
SET permissoes = jsonb_build_object(
  'ordens_servico', true,        -- ‚úÖ Acesso a OS
  'pode_criar_os', true,
  'pode_editar_os', true,
  'pode_finalizar_os', true,
  'configuracoes', false,        -- ‚ùå Sem acesso a Config
  'pode_deletar_clientes', false, -- ‚ùå Sem deletar clientes
  'pode_deletar_produtos', false  -- ‚ùå Sem deletar produtos
  -- ... outras permiss√µes
)
WHERE LOWER(nome) LIKE '%jennifer%';
```

### **Caso 2: Novo Vendedor**
1. Acessar **Funcion√°rios**
2. Clicar em **"Novo Funcion√°rio"**
3. Escolher template **"Vendedor"** üîµ
4. Criar funcion√°rio - permiss√µes aplicadas automaticamente

### **Caso 3: Promover Vendedor a Gerente**
1. Editar funcion√°rio vendedor
2. Clicar em **"Ver templates"**
3. Selecionar template **"Gerente"** üü£
4. Salvar altera√ß√µes

---

## üîí Seguran√ßa

### **Regras de Neg√≥cio**
- ‚úÖ Todo novo funcion√°rio recebe permiss√µes b√°sicas (vendas, clientes, produtos - apenas visualiza√ß√£o)
- ‚úÖ Permiss√µes cr√≠ticas (deletar, configura√ß√µes, backup) desabilitadas por padr√£o
- ‚úÖ Somente Admin pode gerenciar funcion√°rios
- ‚úÖ Permiss√µes s√£o validadas no frontend e backend
- ‚úÖ Logs de auditoria para mudan√ßas de permiss√µes

### **Valida√ß√£o de Acesso**
```typescript
// No componente
const { can } = usePermissions();

if (can('vendas', 'criar')) {
  // Permitir criar venda
}

if (can('produtos', 'deletar')) {
  // Mostrar bot√£o de deletar
}
```

---

## üé® Interface Visual

### **Caracter√≠sticas**
- **Responsiva:** Funciona em desktop e tablet
- **Intuitiva:** Toggle switches visuais
- **Organizada:** Categorias expans√≠veis
- **Informativa:** Resumo de permiss√µes ativas
- **Moderna:** Design com TailwindCSS
- **Acess√≠vel:** Cores e √≠cones para identifica√ß√£o r√°pida

### **Cores por Categoria**
- üîµ Azul: Vendas
- üü¢ Verde: Produtos
- üü£ Roxo: Clientes
- üü° Amarelo: Caixa
- üü† Laranja: Ordens de Servi√ßo
- üîµ √çndigo: Relat√≥rios
- üî¥ Vermelho: Administra√ß√£o

---

## üìö Arquivo de Instala√ß√£o

Execute o script SQL para configurar o sistema:

**Arquivo:** `MELHORAR_SISTEMA_PERMISSOES.sql`

```bash
# Execute no Supabase SQL Editor
# Ou via CLI:
psql -U postgres -d seu_banco -f MELHORAR_SISTEMA_PERMISSOES.sql
```

---

## ‚úÖ Checklist de Implementa√ß√£o

- [x] Criar componente PermissionsManager
- [x] Criar p√°gina FuncionariosPage
- [x] Atualizar hook useEmpresa
- [x] Criar script SQL de migra√ß√£o
- [x] Definir templates predefinidos
- [x] Criar fun√ß√£o SQL aplicar_template_permissoes
- [x] Documentar sistema
- [x] Aplicar permiss√µes da Jennifer
- [ ] Testar cria√ß√£o de novo funcion√°rio
- [ ] Testar aplica√ß√£o de templates
- [ ] Validar UI responsiva
- [ ] Testar valida√ß√£o de acesso no frontend

---

## üêõ Solu√ß√£o de Problemas

### **Problema: Permiss√µes n√£o aparecem no sistema**
```sql
-- Verificar estrutura da tabela
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'funcionarios';

-- Verificar se campo √© JSONB
ALTER TABLE funcionarios 
ALTER COLUMN permissoes TYPE jsonb USING permissoes::jsonb;
```

### **Problema: Funcion√°rio n√£o v√™ m√≥dulo mesmo com permiss√£o**
1. Verificar se permiss√£o do m√≥dulo principal est√° ativa
2. Limpar cache do navegador
3. Fazer logout/login
4. Verificar no SQL:
```sql
SELECT nome, permissoes->>'ordens_servico' 
FROM funcionarios 
WHERE nome LIKE '%nome%';
```

### **Problema: Template n√£o aplicado corretamente**
```sql
-- Reexecutar fun√ß√£o
SELECT aplicar_template_permissoes('uuid', 'template_nome');

-- Verificar resultado
SELECT nome, jsonb_pretty(permissoes) 
FROM funcionarios 
WHERE id = 'uuid';
```

---

## üéâ Resultado Final

Agora voc√™ tem:
- ‚úÖ **Interface visual moderna** e intuitiva
- ‚úÖ **5 templates predefinidos** prontos para uso
- ‚úÖ **Sistema granular** de permiss√µes
- ‚úÖ **F√°cil manuten√ß√£o** via UI ou SQL
- ‚úÖ **Seguran√ßa aprimorada** com valida√ß√µes
- ‚úÖ **Documenta√ß√£o completa**

---

## üìû Suporte

Para d√∫vidas ou problemas:
1. Consulte esta documenta√ß√£o
2. Verifique o arquivo `MELHORAR_SISTEMA_PERMISSOES.sql`
3. Execute queries de diagn√≥stico fornecidas
4. Verifique logs do console do navegador

---

**Desenvolvido para PDV Allimport v2.2.3** üöÄ
