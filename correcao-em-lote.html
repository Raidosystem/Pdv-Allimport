<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß CORRE√á√ÉO EM LOTE - Clientes √ìrf√£os</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: monospace;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            background: #000;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #00ff00;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            margin: 10px 5px;
        }
        button:hover {
            background: #00cc00;
        }
        button.danger {
            background: #ff4444;
            color: white;
        }
        button.danger:hover {
            background: #ff6666;
        }
        #resultado {
            background: #111;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            white-space: pre-wrap;
            border: 1px solid #333;
            max-height: 700px;
            overflow-y: auto;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        .info { color: #00aaff; }
        h1 { color: #00ff00; text-align: center; }
        h2 { color: #ffaa00; }
        .stats {
            background: #222;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #00ff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß CORRE√á√ÉO EM LOTE - Clientes e Ordens √ìrf√£os</h1>
        
        <h2>üö® Problema Identificado</h2>
        <p>M√∫ltiplos clientes e ordens "sumiram" devido a inconsist√™ncias de user_id.</p>
        
        <div class="stats">
            <strong>Casos conhecidos:</strong><br>
            ‚Ä¢ Juliano Ramos (Tel: 17999784438) - Motorola g200<br>
            ‚Ä¢ Cristiano Ramos Mendes (CPF: 28219618809, Tel: 17999783012) - iPhone 15 Pro Max<br>
            ‚Ä¢ Possivelmente outros...
        </div>
        
        <div>
            <button onclick="fazerLogin()">üîë Login</button>
            <button onclick="diagnosticarOrfaos()">üîç Encontrar √ìrf√£os</button>
            <button onclick="corrigirEspecificos()">üéØ Corrigir Casos Conhecidos</button>
            <button onclick="corrigirTodosOrfaos()" class="danger">‚ö° CORRE√á√ÉO EM LOTE</button>
            <button onclick="verificarResultado()">‚úÖ Verificar Resultado</button>
        </div>
        
        <div id="resultado">Aguardando a√ß√£o...</div>
    </div>

    <script>
        // Configura√ß√£o do Supabase (corrigida com as credenciais corretas)
        const SUPABASE_URL = 'https://qcwovwjsmacszjxtqicp.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjd292d2pzbWFjc3pqeHRxaWNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjY0MjU4MDYsImV4cCI6MjA0MjAwMTgwNn0.gH-mEUK8xqI1AEzz2G5q1aH2JK3IfEJdPsJz_tLxYQs'
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        let userIdCorreto = null
        
        function log(message, type = 'info') {
            const resultado = document.getElementById('resultado')
            const timestamp = new Date().toLocaleTimeString()
            const className = type
            resultado.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`
            resultado.scrollTop = resultado.scrollHeight
        }
        
        function clearLog() {
            document.getElementById('resultado').innerHTML = ''
        }
        
        async function fazerLogin() {
            log('üîë Fazendo login...', 'info')
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'assistenciaallimport10@gmail.com',
                    password: '123456'
                })
                
                if (error) {
                    log(`‚ùå Erro: ${error.message}`, 'error')
                    return
                }
                
                userIdCorreto = data.user.id
                log('‚úÖ Login realizado com sucesso!', 'success')
                log(`üÜî User ID correto: ${userIdCorreto}`, 'info')
                
            } catch (err) {
                log(`‚ùå Erro: ${err.message}`, 'error')
            }
        }
        
        async function diagnosticarOrfaos() {
            log('üîç DIAGN√ìSTICO: Procurando clientes e ordens √≥rf√£os...', 'warning')
            
            if (!userIdCorreto) {
                log('‚ùå Fa√ßa login primeiro!', 'error')
                return
            }
            
            try {
                // 1. Buscar clientes √≥rf√£os (sem user_id ou com user_id errado)
                log('üìã 1. Procurando clientes √≥rf√£os...', 'info')
                const { data: clientesOrfaos, error: errorClientes } = await supabase
                    .from('clientes')
                    .select('*')
                    .or(`usuario_id.is.null,usuario_id.neq.${userIdCorreto}`)
                
                if (errorClientes) {
                    log(`‚ùå Erro ao buscar clientes: ${errorClientes.message}`, 'error')
                } else {
                    log(`üìä CLIENTES √ìRF√ÉOS ENCONTRADOS: ${clientesOrfaos?.length || 0}`, 'warning')
                    if (clientesOrfaos && clientesOrfaos.length > 0) {
                        clientesOrfaos.forEach((cliente, index) => {
                            log(`   ${index + 1}. ${cliente.nome} - Tel: ${cliente.telefone} - CPF: ${cliente.cpf || 'N/A'}`, 'info')
                        })
                    }
                }
                
                // 2. Buscar ordens √≥rf√£os
                log('üìã 2. Procurando ordens √≥rf√£s...', 'info')
                const { data: ordensOrfas, error: errorOrdens } = await supabase
                    .from('ordens_servico')
                    .select('*')
                    .or(`usuario_id.is.null,usuario_id.neq.${userIdCorreto}`)
                
                if (errorOrdens) {
                    log(`‚ùå Erro ao buscar ordens: ${errorOrdens.message}`, 'error')
                } else {
                    log(`üìä ORDENS √ìRF√ÉS ENCONTRADAS: ${ordensOrfas?.length || 0}`, 'warning')
                    if (ordensOrfas && ordensOrfas.length > 0) {
                        ordensOrfas.forEach((ordem, index) => {
                            log(`   ${index + 1}. ${ordem.numero_os} - ${ordem.marca} ${ordem.modelo} - Status: ${ordem.status}`, 'info')
                        })
                    }
                }
                
                // 3. Buscar especificamente os casos conhecidos
                log('üìã 3. Verificando casos conhecidos...', 'info')
                
                // Cristiano Ramos Mendes
                const { data: cristiano } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('telefone', '17999783012')
                    .single()
                
                if (cristiano) {
                    log(`üë§ Cristiano Ramos Mendes encontrado: ${cristiano.nome}`, 'success')
                    log(`   User ID atual: ${cristiano.usuario_id}`, 'warning')
                    log(`   CPF: ${cristiano.cpf}`, 'info')
                } else {
                    log('‚ùå Cristiano Ramos Mendes n√£o encontrado', 'error')
                }
                
                // Juliano Ramos (j√° corrigido?)
                const { data: juliano } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('telefone', '17999784438')
                    .single()
                
                if (juliano) {
                    log(`üë§ Juliano Ramos encontrado: ${juliano.nome}`, 'success')
                    log(`   User ID atual: ${juliano.usuario_id}`, juliano.usuario_id === userIdCorreto ? 'success' : 'warning')
                } else {
                    log('‚ùå Juliano Ramos n√£o encontrado', 'error')
                }
                
            } catch (err) {
                log(`‚ùå Erro no diagn√≥stico: ${err.message}`, 'error')
            }
        }
        
        async function corrigirEspecificos() {
            log('üéØ CORRE√á√ÉO: Casos espec√≠ficos conhecidos...', 'warning')
            
            if (!userIdCorreto) {
                log('‚ùå Fa√ßa login primeiro!', 'error')
                return
            }
            
            try {
                // 1. Corrigir Cristiano Ramos Mendes
                log('üîß Corrigindo Cristiano Ramos Mendes...', 'info')
                const { data: cristianoCorrigido, error: errorCristiano } = await supabase
                    .from('clientes')
                    .update({ usuario_id: userIdCorreto })
                    .eq('telefone', '17999783012')
                    .select()
                
                if (errorCristiano) {
                    log(`‚ùå Erro ao corrigir Cristiano: ${errorCristiano.message}`, 'error')
                } else if (cristianoCorrigido && cristianoCorrigido.length > 0) {
                    log(`‚úÖ Cristiano corrigido: ${cristianoCorrigido[0].nome}`, 'success')
                    
                    // Corrigir ordens do Cristiano
                    const { data: ordensCorrigidas } = await supabase
                        .from('ordens_servico')
                        .update({ usuario_id: userIdCorreto })
                        .eq('cliente_id', cristianoCorrigido[0].id)
                        .select()
                    
                    if (ordensCorrigidas && ordensCorrigidas.length > 0) {
                        log(`‚úÖ ${ordensCorrigidas.length} ordens do Cristiano corrigidas`, 'success')
                        ordensCorrigidas.forEach(ordem => {
                            log(`   ‚Ä¢ ${ordem.numero_os} - ${ordem.marca} ${ordem.modelo}`, 'success')
                        })
                    }
                } else {
                    log('‚ö†Ô∏è Cristiano n√£o encontrado pelo telefone', 'warning')
                }
                
                // 2. Re-corrigir Juliano Ramos (garantir)
                log('üîß Re-verificando Juliano Ramos...', 'info')
                const { data: julianoCorrigido, error: errorJuliano } = await supabase
                    .from('clientes')
                    .update({ usuario_id: userIdCorreto })
                    .eq('telefone', '17999784438')
                    .select()
                
                if (julianoCorrigido && julianoCorrigido.length > 0) {
                    log(`‚úÖ Juliano re-corrigido: ${julianoCorrigido[0].nome}`, 'success')
                }
                
                // 3. Corrigir ordem espec√≠fica OS-20250915-003
                const { data: ordemEspecifica } = await supabase
                    .from('ordens_servico')
                    .update({ usuario_id: userIdCorreto })
                    .eq('numero_os', 'OS-20250915-003')
                    .select()
                
                if (ordemEspecifica && ordemEspecifica.length > 0) {
                    log(`‚úÖ Ordem OS-20250915-003 corrigida`, 'success')
                }
                
                log('üéâ CORRE√á√ÉO DOS CASOS ESPEC√çFICOS CONCLU√çDA!', 'success')
                
            } catch (err) {
                log(`‚ùå Erro na corre√ß√£o: ${err.message}`, 'error')
            }
        }
        
        async function corrigirTodosOrfaos() {
            log('‚ö° CORRE√á√ÉO EM LOTE: Corrigindo TODOS os √≥rf√£os...', 'warning')
            log('üö® ATEN√á√ÉO: Esta opera√ß√£o ir√° corrigir TODOS os dados √≥rf√£os!', 'warning')
            
            if (!userIdCorreto) {
                log('‚ùå Fa√ßa login primeiro!', 'error')
                return
            }
            
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° corrigir TODOS os clientes e ordens √≥rf√£os. Continuar?')) {
                log('‚ùå Opera√ß√£o cancelada pelo usu√°rio', 'warning')
                return
            }
            
            try {
                // 1. Corrigir todos os clientes √≥rf√£os
                log('üîß Corrigindo TODOS os clientes √≥rf√£os...', 'info')
                const { data: clientesCorrigidos, error: errorClientes } = await supabase
                    .from('clientes')
                    .update({ usuario_id: userIdCorreto })
                    .or(`usuario_id.is.null,usuario_id.neq.${userIdCorreto}`)
                    .select()
                
                if (errorClientes) {
                    log(`‚ùå Erro ao corrigir clientes: ${errorClientes.message}`, 'error')
                } else {
                    log(`‚úÖ ${clientesCorrigidos?.length || 0} clientes corrigidos!`, 'success')
                }
                
                // 2. Corrigir todas as ordens √≥rf√£s
                log('üîß Corrigindo TODAS as ordens √≥rf√£s...', 'info')
                const { data: ordensCorrigidas, error: errorOrdens } = await supabase
                    .from('ordens_servico')
                    .update({ usuario_id: userIdCorreto })
                    .or(`usuario_id.is.null,usuario_id.neq.${userIdCorreto}`)
                    .select()
                
                if (errorOrdens) {
                    log(`‚ùå Erro ao corrigir ordens: ${errorOrdens.message}`, 'error')
                } else {
                    log(`‚úÖ ${ordensCorrigidas?.length || 0} ordens corrigidas!`, 'success')
                }
                
                log('üéâ CORRE√á√ÉO EM LOTE CONCLU√çDA!', 'success')
                log('üìù Agora teste o sistema para confirmar que tudo aparece', 'info')
                
            } catch (err) {
                log(`‚ùå Erro na corre√ß√£o em lote: ${err.message}`, 'error')
            }
        }
        
        async function verificarResultado() {
            log('‚úÖ VERIFICA√á√ÉO: Testando resultados...', 'info')
            
            if (!userIdCorreto) {
                log('‚ùå Fa√ßa login primeiro!', 'error')
                return
            }
            
            try {
                // 1. Contar clientes do usu√°rio
                const { data: clientes, count: countClientes } = await supabase
                    .from('clientes')
                    .select('*', { count: 'exact' })
                    .eq('usuario_id', userIdCorreto)
                
                log(`üìä CLIENTES DO USU√ÅRIO: ${countClientes || 0}`, 'success')
                
                // 2. Contar ordens do usu√°rio
                const { data: ordens, count: countOrdens } = await supabase
                    .from('ordens_servico')
                    .select('*', { count: 'exact' })
                    .eq('usuario_id', userIdCorreto)
                
                log(`üìä ORDENS DO USU√ÅRIO: ${countOrdens || 0}`, 'success')
                
                // 3. Verificar casos espec√≠ficos
                const { data: juliano } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('telefone', '17999784438')
                    .eq('usuario_id', userIdCorreto)
                
                if (juliano && juliano.length > 0) {
                    log(`‚úÖ Juliano Ramos: APARECENDO (${juliano[0].nome})`, 'success')
                } else {
                    log(`‚ùå Juliano Ramos: N√ÉO APARECENDO`, 'error')
                }
                
                const { data: cristiano } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('telefone', '17999783012')
                    .eq('usuario_id', userIdCorreto)
                
                if (cristiano && cristiano.length > 0) {
                    log(`‚úÖ Cristiano Ramos Mendes: APARECENDO (${cristiano[0].nome})`, 'success')
                } else {
                    log(`‚ùå Cristiano Ramos Mendes: N√ÉO APARECENDO`, 'error')
                }
                
                // 4. Verificar ordem espec√≠fica
                const { data: ordemEspecifica } = await supabase
                    .from('ordens_servico')
                    .select('numero_os, marca, modelo, status')
                    .eq('numero_os', 'OS-20250915-003')
                    .eq('usuario_id', userIdCorreto)
                
                if (ordemEspecifica && ordemEspecifica.length > 0) {
                    log(`‚úÖ Ordem OS-20250915-003: APARECENDO (${ordemEspecifica[0].marca} ${ordemEspecifica[0].modelo})`, 'success')
                } else {
                    log(`‚ùå Ordem OS-20250915-003: N√ÉO APARECENDO`, 'error')
                }
                
                log('üìù Agora teste o sistema em: http://localhost:5186/ordens-servico', 'info')
                
            } catch (err) {
                log(`‚ùå Erro na verifica√ß√£o: ${err.message}`, 'error')
            }
        }
        
        // Inicializa√ß√£o
        window.onload = async () => {
            log('üîß Ferramenta de Corre√ß√£o em Lote carregada!', 'success')
            log('üìù Execute na ordem:', 'info')
            log('  1. Login', 'info')
            log('  2. Diagn√≥stico', 'info')
            log('  3. Corre√ß√£o Espec√≠fica ou Em Lote', 'info')
            log('  4. Verifica√ß√£o', 'info')
            log('', 'info')
        }
    </script>
</body>
</html>