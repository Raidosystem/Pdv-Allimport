<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Avan√ßado - OS-20250915-003</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: monospace;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            background: #000;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #00ff00;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            margin: 10px 5px;
        }
        button:hover {
            background: #00cc00;
        }
        #resultado {
            background: #111;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            white-space: pre-wrap;
            border: 1px solid #333;
            max-height: 600px;
            overflow-y: auto;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        .info { color: #00aaff; }
        h1 { color: #00ff00; text-align: center; }
        h2 { color: #ffaa00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ DIAGN√ìSTICO AVAN√áADO - OS-20250915-003</h1>
        
        <h2>üîç Testes Espec√≠ficos</h2>
        <p>Vamos descobrir exatamente por que a ordem n√£o aparece no frontend.</p>
        
        <div>
            <button onclick="fazerLogin()">üîë Login</button>
            <button onclick="testeSimples()">üìã Teste Simples</button>
            <button onclick="testeComJoin()">üîó Teste com JOIN</button>
            <button onclick="testeExatoSistema()">üéØ Teste Exato do Sistema</button>
            <button onclick="verificarRelacionamento()">üîÑ Ver Relacionamentos</button>
            <button onclick="corrigirRelacionamento()">üîß Corrigir JOIN</button>
        </div>
        
        <div id="resultado">Aguardando a√ß√£o...</div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://qcwovwjsmacszjxtqicp.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjd292d2pzbWFjc3pqeHRxaWNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjY0MjU4MDYsImV4cCI6MjA0MjAwMTgwNn0.gH-mEUK8xqI1AEzz2G5q1aH2JK3IfEJdPsJz_tLxYQs'
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        function log(message, type = 'info') {
            const resultado = document.getElementById('resultado')
            const timestamp = new Date().toLocaleTimeString()
            const className = type
            resultado.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`
            resultado.scrollTop = resultado.scrollHeight
        }
        
        function clearLog() {
            document.getElementById('resultado').innerHTML = ''
        }
        
        async function fazerLogin() {
            log('üîë Fazendo login...', 'info')
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'assistenciaallimport10@gmail.com',
                    password: '123456'
                })
                
                if (error) {
                    log(`‚ùå Erro: ${error.message}`, 'error')
                    return
                }
                
                log('‚úÖ Login OK!', 'success')
                log(`User ID: ${data.user.id}`, 'info')
                
            } catch (err) {
                log(`‚ùå Erro: ${err.message}`, 'error')
            }
        }
        
        async function testeSimples() {
            log('üìã TESTE 1: Busca simples da ordem...', 'warning')
            
            try {
                const { data: { user } } = await supabase.auth.getUser()
                if (!user) {
                    log('‚ùå Fa√ßa login primeiro!', 'error')
                    return
                }
                
                // Busca apenas a ordem, sem JOIN
                const { data: ordem, error } = await supabase
                    .from('ordens_servico')
                    .select('*')
                    .eq('numero_os', 'OS-20250915-003')
                    .single()
                
                if (error) {
                    log(`‚ùå Erro: ${error.message}`, 'error')
                    return
                }
                
                if (ordem) {
                    log('‚úÖ ORDEM ENCONTRADA:', 'success')
                    log(`   N√∫mero: ${ordem.numero_os}`, 'info')
                    log(`   User ID: ${ordem.usuario_id}`, 'info')
                    log(`   Cliente ID: ${ordem.cliente_id}`, 'info')
                    log(`   Status: ${ordem.status}`, 'info')
                    log(`   Marca: ${ordem.marca}`, 'info')
                    log(`   Modelo: ${ordem.modelo}`, 'info')
                    log(`   Data: ${ordem.created_at}`, 'info')
                    
                    if (ordem.usuario_id === user.id) {
                        log('‚úÖ User ID est√° correto!', 'success')
                    } else {
                        log('‚ùå User ID est√° errado!', 'error')
                        log(`   Esperado: ${user.id}`, 'error')
                        log(`   Atual: ${ordem.usuario_id}`, 'error')
                    }
                } else {
                    log('‚ùå Ordem n√£o encontrada!', 'error')
                }
                
            } catch (err) {
                log(`‚ùå Erro: ${err.message}`, 'error')
            }
        }
        
        async function testeComJoin() {
            log('üîó TESTE 2: Busca com JOIN (como o sistema faz)...', 'warning')
            
            try {
                const { data: { user } } = await supabase.auth.getUser()
                if (!user) {
                    log('‚ùå Fa√ßa login primeiro!', 'error')
                    return
                }
                
                // Busca com JOIN como o sistema faz
                const { data: ordens, error } = await supabase
                    .from('ordens_servico')
                    .select(`
                        *,
                        cliente:clientes(*)
                    `)
                    .eq('usuario_id', user.id)
                    .eq('numero_os', 'OS-20250915-003')
                
                if (error) {
                    log(`‚ùå Erro no JOIN: ${error.message}`, 'error')
                    return
                }
                
                if (ordens && ordens.length > 0) {
                    const ordem = ordens[0]
                    log('‚úÖ ORDEM ENCONTRADA COM JOIN:', 'success')
                    log(`   N√∫mero: ${ordem.numero_os}`, 'info')
                    log(`   Cliente: ${JSON.stringify(ordem.cliente, null, 2)}`, 'info')
                } else {
                    log('‚ùå Ordem n√£o encontrada com JOIN!', 'error')
                    log('üí° Isso pode ser o problema!', 'warning')
                }
                
            } catch (err) {
                log(`‚ùå Erro: ${err.message}`, 'error')
            }
        }
        
        async function testeExatoSistema() {
            log('üéØ TESTE 3: Exatamente como o sistema busca...', 'warning')
            
            try {
                const { data: { user } } = await supabase.auth.getUser()
                if (!user) {
                    log('‚ùå Fa√ßa login primeiro!', 'error')
                    return
                }
                
                // Busca exatamente como no ordemServicoService.ts
                const { data: ordens, error } = await supabase
                    .from('ordens_servico')
                    .select(`
                        *,
                        cliente:clientes(*)
                    `)
                    .eq('usuario_id', user.id)
                    .order('created_at', { ascending: false })
                
                if (error) {
                    log(`‚ùå Erro: ${error.message}`, 'error')
                    return
                }
                
                log(`üìä Total de ordens encontradas: ${ordens?.length || 0}`, 'info')
                
                if (ordens && ordens.length > 0) {
                    log('üìã TODAS AS ORDENS DO USU√ÅRIO:', 'info')
                    ordens.forEach((ordem, index) => {
                        log(`${index + 1}. ${ordem.numero_os} - ${ordem.marca} ${ordem.modelo} (${ordem.status})`, 'info')
                        if (ordem.numero_os === 'OS-20250915-003') {
                            log(`   ‚úÖ ENCONTRADA! Cliente: ${ordem.cliente?.nome || 'SEM CLIENTE'}`, 'success')
                        }
                    })
                    
                    const ordemTarget = ordens.find(o => o.numero_os === 'OS-20250915-003')
                    if (ordemTarget) {
                        log('üéâ A ordem OS-20250915-003 EST√Å na busca do sistema!', 'success')
                    } else {
                        log('‚ùå A ordem OS-20250915-003 N√ÉO est√° na busca do sistema!', 'error')
                    }
                } else {
                    log('‚ùå Nenhuma ordem encontrada para este usu√°rio!', 'error')
                }
                
            } catch (err) {
                log(`‚ùå Erro: ${err.message}`, 'error')
            }
        }
        
        async function verificarRelacionamento() {
            log('üîÑ TESTE 4: Verificando relacionamentos...', 'warning')
            
            try {
                const { data: { user } } = await supabase.auth.getUser()
                if (!user) {
                    log('‚ùå Fa√ßa login primeiro!', 'error')
                    return
                }
                
                // 1. Buscar a ordem
                const { data: ordem } = await supabase
                    .from('ordens_servico')
                    .select('*')
                    .eq('numero_os', 'OS-20250915-003')
                    .single()
                
                if (!ordem) {
                    log('‚ùå Ordem n√£o encontrada!', 'error')
                    return
                }
                
                log(`üìã Ordem encontrada: ${ordem.numero_os}`, 'info')
                log(`   Cliente ID: ${ordem.cliente_id}`, 'info')
                log(`   User ID: ${ordem.usuario_id}`, 'info')
                
                // 2. Buscar o cliente
                const { data: cliente } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('id', ordem.cliente_id)
                    .single()
                
                if (cliente) {
                    log(`üë§ Cliente encontrado: ${cliente.nome}`, 'success')
                    log(`   Telefone: ${cliente.telefone}`, 'info')
                    log(`   User ID: ${cliente.usuario_id}`, 'info')
                    
                    if (cliente.usuario_id === user.id) {
                        log('‚úÖ User ID do cliente est√° correto!', 'success')
                    } else {
                        log('‚ùå User ID do cliente est√° errado!', 'error')
                        log(`   Esperado: ${user.id}`, 'error')
                        log(`   Atual: ${cliente.usuario_id}`, 'error')
                    }
                } else {
                    log('‚ùå Cliente n√£o encontrado!', 'error')
                }
                
            } catch (err) {
                log(`‚ùå Erro: ${err.message}`, 'error')
            }
        }
        
        async function corrigirRelacionamento() {
            log('üîß CORRE√á√ÉO: Garantindo relacionamento correto...', 'warning')
            
            try {
                const { data: { user } } = await supabase.auth.getUser()
                if (!user) {
                    log('‚ùå Fa√ßa login primeiro!', 'error')
                    return
                }
                
                const userIdCorreto = user.id
                
                // 1. Corrigir ordem
                log('üîß Corrigindo ordem de servi√ßo...', 'info')
                const { data: ordemAtualizada, error: errorOrdem } = await supabase
                    .from('ordens_servico')
                    .update({ usuario_id: userIdCorreto })
                    .eq('numero_os', 'OS-20250915-003')
                    .select()
                
                if (errorOrdem) {
                    log(`‚ùå Erro ao corrigir ordem: ${errorOrdem.message}`, 'error')
                } else if (ordemAtualizada && ordemAtualizada.length > 0) {
                    log('‚úÖ Ordem corrigida!', 'success')
                }
                
                // 2. Corrigir cliente espec√≠fico da ordem
                if (ordemAtualizada && ordemAtualizada.length > 0) {
                    const ordem = ordemAtualizada[0]
                    log(`üîß Corrigindo cliente ID: ${ordem.cliente_id}...`, 'info')
                    
                    const { data: clienteAtualizado, error: errorCliente } = await supabase
                        .from('clientes')
                        .update({ usuario_id: userIdCorreto })
                        .eq('id', ordem.cliente_id)
                        .select()
                    
                    if (errorCliente) {
                        log(`‚ùå Erro ao corrigir cliente: ${errorCliente.message}`, 'error')
                    } else if (clienteAtualizado && clienteAtualizado.length > 0) {
                        log(`‚úÖ Cliente corrigido: ${clienteAtualizado[0].nome}`, 'success')
                    }
                }
                
                log('üéâ CORRE√á√ÉO COMPLETA!', 'success')
                log('üìù Agora teste no sistema: http://localhost:5186/ordens-servico', 'info')
                
            } catch (err) {
                log(`‚ùå Erro na corre√ß√£o: ${err.message}`, 'error')
            }
        }
        
        // Inicializa√ß√£o
        window.onload = async () => {
            log('üî¨ Diagn√≥stico Avan√ßado carregado!', 'success')
            log('üìù Execute os testes na ordem para identificar o problema:', 'info')
            log('', 'info')
        }
    </script>
</body>
</html>