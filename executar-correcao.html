<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executar Corre√ß√£o - PDV Allimport</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            background: #000;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #00ff00;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            margin: 10px 0;
        }
        button:hover {
            background: #00cc00;
        }
        #resultado {
            background: #111;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            white-space: pre-wrap;
            border: 1px solid #333;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        .info { color: #00aaff; }
        h1 { color: #00ff00; text-align: center; }
        h2 { color: #ffaa00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß CORRE√á√ÉO FOR√áADA - OS-20250915-003</h1>
        
        <h2>üìã Status Atual</h2>
        <p>Esta ferramenta vai corrigir a ordem de servi√ßo que n√£o est√° aparecendo.</p>
        
        <div>
            <button onclick="fazerLogin()">1. üîë Fazer Login</button>
            <button onclick="diagnosticar()">2. üîç Diagnosticar Problema</button>
            <button onclick="executarCorrecao()">3. üî• EXECUTAR CORRE√á√ÉO</button>
            <button onclick="verificarResultado()">4. ‚úÖ Verificar Resultado</button>
        </div>
        
        <div id="resultado">Aguardando a√ß√£o...</div>
    </div>

    <script>
        // Configura√ß√£o do Supabase (usando as mesmas vari√°veis do projeto)
        const SUPABASE_URL = 'https://qcwovwjsmacszjxtqicp.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjd292d2pzbWFjc3pqeHRxaWNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjY0MjU4MDYsImV4cCI6MjA0MjAwMTgwNn0.gH-mEUK8xqI1AEzz2G5q1aH2JK3IfEJdPsJz_tLxYQs'
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        function log(message, type = 'info') {
            const resultado = document.getElementById('resultado')
            const timestamp = new Date().toLocaleTimeString()
            const className = type
            resultado.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`
            resultado.scrollTop = resultado.scrollHeight
        }
        
        async function fazerLogin() {
            log('üîë Iniciando processo de login...', 'info')
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'assistenciaallimport10@gmail.com',
                    password: '123456'
                })
                
                if (error) {
                    log(`‚ùå Erro no login: ${error.message}`, 'error')
                    return
                }
                
                log('‚úÖ Login realizado com sucesso!', 'success')
                log(`üë§ Usu√°rio: ${data.user.email}`, 'info')
                log(`üÜî User ID: ${data.user.id}`, 'info')
                
            } catch (err) {
                log(`‚ùå Erro inesperado: ${err.message}`, 'error')
            }
        }
        
        async function diagnosticar() {
            log('üîç Iniciando diagn√≥stico...', 'info')
            
            try {
                // Verificar se est√° logado
                const { data: { user } } = await supabase.auth.getUser()
                if (!user) {
                    log('‚ùå Usu√°rio n√£o est√° logado. Fa√ßa login primeiro!', 'error')
                    return
                }
                
                log(`‚úÖ Usu√°rio logado: ${user.email} (${user.id})`, 'success')
                
                // Buscar a ordem problem√°tica
                const { data: ordem, error: errorOrdem } = await supabase
                    .from('ordens_servico')
                    .select(`
                        numero_os,
                        usuario_id,
                        cliente_id,
                        marca,
                        modelo,
                        clientes:cliente_id(nome, telefone, usuario_id)
                    `)
                    .eq('numero_os', 'OS-20250915-003')
                    .single()
                
                if (errorOrdem) {
                    log(`‚ùå Erro ao buscar ordem: ${errorOrdem.message}`, 'error')
                    return
                }
                
                if (ordem) {
                    log('üìã ORDEM ENCONTRADA:', 'info')
                    log(`   N√∫mero: ${ordem.numero_os}`, 'info')
                    log(`   User ID da Ordem: ${ordem.usuario_id}`, 'warning')
                    log(`   User ID Correto: ${user.id}`, 'success')
                    log(`   Cliente: ${ordem.clientes?.nome || 'N/A'}`, 'info')
                    log(`   Tel Cliente: ${ordem.clientes?.telefone || 'N/A'}`, 'info')
                    log(`   User ID do Cliente: ${ordem.clientes?.usuario_id || 'N/A'}`, 'warning')
                    
                    if (ordem.usuario_id !== user.id) {
                        log('‚ö†Ô∏è PROBLEMA IDENTIFICADO: User ID da ordem est√° diferente!', 'warning')
                        log('üîß Corre√ß√£o necess√°ria.', 'warning')
                    } else {
                        log('‚úÖ User ID da ordem est√° correto!', 'success')
                    }
                } else {
                    log('‚ùå Ordem OS-20250915-003 n√£o encontrada!', 'error')
                }
                
            } catch (err) {
                log(`‚ùå Erro no diagn√≥stico: ${err.message}`, 'error')
            }
        }
        
        async function executarCorrecao() {
            log('üî• INICIANDO CORRE√á√ÉO FOR√áADA...', 'warning')
            
            try {
                // Verificar se est√° logado
                const { data: { user } } = await supabase.auth.getUser()
                if (!user) {
                    log('‚ùå Usu√°rio n√£o est√° logado. Fa√ßa login primeiro!', 'error')
                    return
                }
                
                const userIdCorreto = user.id
                log(`üéØ User ID correto: ${userIdCorreto}`, 'info')
                
                // 1. Corrigir a ordem de servi√ßo
                log('üîß Corrigindo ordem de servi√ßo...', 'info')
                const { data: ordemAtualizada, error: errorOrdem } = await supabase
                    .from('ordens_servico')
                    .update({ usuario_id: userIdCorreto })
                    .eq('numero_os', 'OS-20250915-003')
                    .select()
                
                if (errorOrdem) {
                    log(`‚ùå Erro ao corrigir ordem: ${errorOrdem.message}`, 'error')
                    return
                }
                
                if (ordemAtualizada && ordemAtualizada.length > 0) {
                    log('‚úÖ Ordem de servi√ßo corrigida!', 'success')
                    log(`   N√∫mero: ${ordemAtualizada[0].numero_os}`, 'success')
                    log(`   Novo User ID: ${ordemAtualizada[0].usuario_id}`, 'success')
                } else {
                    log('‚ö†Ô∏è Nenhuma ordem foi atualizada', 'warning')
                }
                
                // 2. Corrigir o cliente (telefone 17999784438)
                log('üîß Corrigindo cliente...', 'info')
                const { data: clienteAtualizado, error: errorCliente } = await supabase
                    .from('clientes')
                    .update({ usuario_id: userIdCorreto })
                    .eq('telefone', '17999784438')
                    .select()
                
                if (errorCliente) {
                    log(`‚ùå Erro ao corrigir cliente: ${errorCliente.message}`, 'error')
                } else if (clienteAtualizado && clienteAtualizado.length > 0) {
                    log('‚úÖ Cliente corrigido!', 'success')
                    log(`   Nome: ${clienteAtualizado[0].nome}`, 'success')
                    log(`   Telefone: ${clienteAtualizado[0].telefone}`, 'success')
                    log(`   Novo User ID: ${clienteAtualizado[0].usuario_id}`, 'success')
                } else {
                    log('‚ö†Ô∏è Nenhum cliente foi atualizado', 'warning')
                }
                
                log('üéâ CORRE√á√ÉO CONCLU√çDA!', 'success')
                log('üìù Execute a verifica√ß√£o para confirmar.', 'info')
                
            } catch (err) {
                log(`‚ùå Erro na corre√ß√£o: ${err.message}`, 'error')
            }
        }
        
        async function verificarResultado() {
            log('‚úÖ Verificando resultado da corre√ß√£o...', 'info')
            
            try {
                // Verificar se est√° logado
                const { data: { user } } = await supabase.auth.getUser()
                if (!user) {
                    log('‚ùå Usu√°rio n√£o est√° logado. Fa√ßa login primeiro!', 'error')
                    return
                }
                
                // Buscar a ordem exatamente como o sistema faz
                const { data: ordens, error } = await supabase
                    .from('ordens_servico')
                    .select(`
                        numero_os,
                        status,
                        tipo,
                        marca,
                        modelo,
                        usuario_id,
                        created_at,
                        clientes:cliente_id(nome, telefone)
                    `)
                    .eq('usuario_id', user.id)
                    .eq('numero_os', 'OS-20250915-003')
                
                if (error) {
                    log(`‚ùå Erro na verifica√ß√£o: ${error.message}`, 'error')
                    return
                }
                
                if (ordens && ordens.length > 0) {
                    const ordem = ordens[0]
                    log('üéâ SUCESSO! A ordem agora aparece corretamente:', 'success')
                    log(`   N√∫mero: ${ordem.numero_os}`, 'success')
                    log(`   Status: ${ordem.status}`, 'success')
                    log(`   Equipamento: ${ordem.marca} ${ordem.modelo}`, 'success')
                    log(`   Cliente: ${ordem.clientes?.nome || 'N/A'}`, 'success')
                    log(`   Data: ${new Date(ordem.created_at).toLocaleString()}`, 'success')
                    log('', 'info')
                    log('‚úÖ A ordem OS-20250915-003 deve aparecer no sistema agora!', 'success')
                } else {
                    log('‚ùå A ordem ainda n√£o est√° aparecendo. Pode ser necess√°rio executar a corre√ß√£o novamente.', 'error')
                }
                
                // Mostrar todas as ordens do usu√°rio
                const { data: todasOrdens } = await supabase
                    .from('ordens_servico')
                    .select('numero_os, status, marca, modelo, created_at')
                    .eq('usuario_id', user.id)
                    .order('created_at', { ascending: false })
                    .limit(10)
                
                if (todasOrdens && todasOrdens.length > 0) {
                    log('', 'info')
                    log('üìã √öltimas ordens do usu√°rio:', 'info')
                    todasOrdens.forEach(ordem => {
                        log(`   ${ordem.numero_os} - ${ordem.marca} ${ordem.modelo} (${ordem.status})`, 'info')
                    })
                }
                
            } catch (err) {
                log(`‚ùå Erro na verifica√ß√£o: ${err.message}`, 'error')
            }
        }
        
        // Verificar status inicial
        window.onload = async () => {
            log('üöÄ Ferramenta de corre√ß√£o carregada!', 'success')
            log('üìù Siga os passos na ordem:', 'info')
            log('   1. Fazer Login', 'info')
            log('   2. Diagnosticar', 'info')
            log('   3. Executar Corre√ß√£o', 'info')
            log('   4. Verificar Resultado', 'info')
            log('', 'info')
        }
    </script>
</body>
</html>