<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDV Allimport v2.2.5 - Sistema de Ponto de Venda</title>
    
    <!-- Cache Control - Evitar cache agressivo -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <!-- Sistema de Limpeza de Cache Inline -->
    <script>
      (function() {
        const CACHE_VERSION = '2.2.5';
        const LAST_VERSION = localStorage.getItem('pdv_inline_cache_version');
        
        if (LAST_VERSION !== CACHE_VERSION) {
          console.log('üßπ [INLINE] Limpando cache antigo:', LAST_VERSION, '‚Üí', CACHE_VERSION);
          
          // Limpar caches
          if ('caches' in window) {
            caches.keys().then(names => {
              names.forEach(name => caches.delete(name));
            });
          }
          
          // Desregistrar Service Workers (ignorar erros)
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(regs => {
              regs.forEach(reg => {
                reg.unregister().catch(() => {
                  console.log('‚ö†Ô∏è [INLINE] SW ativo, ser√° removido no pr√≥ximo reload');
                });
              });
            });
          }
          
          // Salvar nova vers√£o
          localStorage.setItem('pdv_inline_cache_version', CACHE_VERSION);
          console.log('‚úÖ [INLINE] Cache limpo e atualizado');
        }
      })();
    </script>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema de ponto de venda completo com PWA" />
    <meta name="theme-color" content="#3b82f6" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="PDV Allimport" />
    
    <!-- PWA MANIFEST - REATIVADO! -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- PWA √çCONES - REATIVADOS! -->
    <link rel="icon" type="image/png" sizes="72x72" href="/icons/icon-72x72.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="/icons/icon-96x96.png" />
    <link rel="icon" type="image/png" sizes="128x128" href="/icons/icon-128x128.png" />
    <link rel="icon" type="image/png" sizes="144x144" href="/icons/icon-144x144.png" />
    <link rel="icon" type="image/png" sizes="152x152" href="/icons/icon-152x152.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="384x384" href="/icons/icon-384x384.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png" />
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
    
    <!-- Windows Metro -->
    <meta name="msapplication-TileColor" content="#3b82f6" />
    <meta name="msapplication-TileImage" content="/icons/icon-144x144.png" />
    
    <!-- CSS Inline Critical -->
    <style>
      body { margin: 0; background: #f9fafb; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
      #root { min-height: 100vh; }
      .loading { display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 18px; color: #6b7280; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    
    <!-- Script Universal de Limpeza de Cache - Cross-Browser -->
    <script>
      (function () {
        // evita executar 2x
        if (window.__bootPatcherLoaded) return;
        window.__bootPatcherLoaded = true;

        // cache-buster para recarregar sem usar cache do navegador
        function hardReload() {
          var u = new URL(location.href);
          u.searchParams.set("_v", Date.now().toString());
          location.replace(u.toString());
        }

        async function deleteIndexedDBSafely() {
          try {
            if ('databases' in indexedDB && typeof indexedDB.databases === 'function') {
              const dbs = await indexedDB.databases();
              await Promise.all((dbs || []).map(db => {
                try { return indexedDB.deleteDatabase(db.name); } catch(e) {}
              }));
            } else {
              // Lista de DBs comuns (ajuste aos seus):
              const known = [
                // Supabase/LocalForage/etc.. ajuste se usar outros
                "supabase-auth",
                "supabase-cache",
                "localforage",
                "keyval-store"
              ];
              await Promise.all(known.map(name => {
                try { return indexedDB.deleteDatabase(name); } catch(e) {}
              }));
            }
          } catch(e) { /* ignora */ }
        }

        async function universalClean() {
          try {
            // 1) CacheStorage (SW caches)
            if ('caches' in self) {
              const keys = await caches.keys();
              await Promise.all(keys.map(k => caches.delete(k).catch(()=>{})));
            }

            // 2) Service Workers
            if ('serviceWorker' in navigator) {
              const regs = await navigator.serviceWorker.getRegistrations();
              await Promise.all(regs.map(r => r.unregister().catch(()=>{})));
            }

            // 3) IndexedDB
            await deleteIndexedDBSafely();

            // 4) local/session storage (s√≥ do seu dom√≠nio)
            try { localStorage.clear(); } catch(e){}
            try { sessionStorage.clear(); } catch(e){}

          } catch (e) {
            // passa
          } finally {
            hardReload();
          }
        }

        // ------------- Detector de vers√£o -------------
        let currentVersion = null;
        async function checkVersion() {
          try {
            const r = await fetch('/version.json', { cache: 'no-store' });
            const j = await r.json();
            if (!currentVersion) currentVersion = j.version;
            else if (currentVersion !== j.version) {
              // Nova vers√£o dispon√≠vel -> limpeza e reload garante pegar HTML/JS novos
              await universalClean();
            }
          } catch (e) {
            // offline? ignora
          }
        }

        // Checa logo no in√≠cio e depois a cada 60s (ajuste se quiser)
        checkVersion();
        setInterval(checkVersion, 60000);

        // ------------- Auto-recovery: erro de chunk/bundle -------------
        // Edge/Chrome/Safari: se algum script falhar (404 de asset antigo), limpa e recarrega
        window.addEventListener('error', function (ev) {
          const msg = (ev && ev.message || '').toLowerCase();
          if (msg.includes('loading chunk') || msg.includes('chunk load') || msg.includes('failed to fetch') || msg.includes('script error')) {
            universalClean();
          }
        }, true);

        window.addEventListener('unhandledrejection', function (ev) {
          const msg = (ev && ev.reason && (ev.reason.message || ev.reason.toString()) || '').toLowerCase();
          if (msg.includes('loading chunk') || msg.includes('chunk load') || msg.includes('failed to fetch') || msg.includes('import()')) {
            universalClean();
          }
        });

        // ------------- Bot√£o/manual (exponha p/ debug da sua UI) -------------
        window.__forceCleanAndReload = universalClean; // voc√™ pode chamar pelo console ou de um bot√£o
      })();
    </script>
    
    <script>
      // Registrar Service Worker apenas em produ√ß√£o
      if ('serviceWorker' in navigator && location.hostname !== 'localhost') {
        navigator.serviceWorker.register('/sw.js').then(() => {
          console.log('‚úÖ Service Worker registrado');
        }).catch(() => {
          console.log('‚ö†Ô∏è Service Worker falhou');
        });
      } else {
        console.log('‚öôÔ∏è Service Worker desabilitado em desenvolvimento');
      }
    </script>
    
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
